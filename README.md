# OptractP2pCLI 
#### Note: Requires NodeJS 10.5.* or newer, recommended: 10.15.3
#### Note: Developers needs to npm install asar as global package.

### Quick howto:
- `git clone ...`
- `npm install `
- `npm run release `
- Install tarball release (assuming to /tmp/Optract)
- `tar xf OptractClient.tar.gz -C /tmp/Optract `
- (Temoprary DEV BUILD setup): Copy keystore and bcup archive into dist/dapps under install root dir.

### Start Service:
- `./optRun `

### Start Console (After service is up)
- `./optRun console` 

### Or ... launch all-in-one dev console without WSRPC:
- First update config in config.json.dist and set node.wsrpc = false.
- `./optRun devConsole`


----

**update**

Above instruction still valid for validator's node.

After merge the `init_setup` branch back to master, the `OptractClient` should be installed in
the following folders (will call it `$basedir` below):

- mac and linux: `~/.config/Optract`
- windows: `~/AppData/Local/Optract`

Under `$basedir` there contain files and directories after installation:
- `dist/`: the main code, include executables, contract related, nativeApp, node_modules
- `config.json`, `ipfs_repo/`, `myArchive.bcup`, and `keystore/`: should keep these file while
  update the main code
    - note that cache files also in `$basedir` and may need to remove them in some cases
- `optract.log`: contain installation log, and a couple lines while `nativeApp` start to work

## To build
- requirements: python2 and pyinstaller installed
    - note: only need to update two lines: `struct.pack()` and `struct.unpack()` to migrate to python3
- `git clone git@github.com:elevenbuckets/OptractP2pCLI.git` 
- `npm install`
- note that the manifest for extension are generated by nativeApp while run install script
- Build release for different platform:
    - linux: `npm run release`
    - mac: `npm run releaseMac64`
    - win: `npm run releaseWin64`
- Now there's a `dist` folder and the corresponding archive `Optract*.tar.gz` or zip file (for windows release). 

To build with pyarmor, need to install pyarmor and register.
- `pip install -U pyarmor`
- download regfile, and add register file
    - `pyarmor register pyarmor-regfile-1.zip`
    - then, run `pyarmor register` should see something like `This code is authorized to ...`
- It's easier to debug with non-obfuscated code. To build without pyarmor, rename the npm script
  `buildNativeAppNoArmor` in `package.json` to `buildNativeApp`, and the original `buildNativeApp`
  to something anything else. Then run `npm run release*` as before.

## To install
- **close browsers which has optract installed and make sure all processes are stop**
- (optional) copy or move `keystore/`, `myArchive.bcup`, and `ipfs_repo` to `$basedir`.
- In terminal, cd into the `dist` folder (extract the `Optract*.tar.gz` if necessary), run the 
  following script to install:
    - `./install.sh` for linux and mac
    - `install.bat` for windows
    - The script copies necessary files into `$basedir`, untar `node_modules.tar`, add registry
      or copy the mainfest of extension to proper places depend on OS

## developing
* to see the console:
    - in OptractP2PCli folder: `cd lib; cp pubsubNode.js libSampleTickets.js console.js ~/.config/Optract/dist`
        - TODO: add npm script for the line above
        - TODO: update the path of config file in `console.js` to `../../` instead of `/../dapps`
    - then open browser and run optract, or:
        - `cd ~/.config/Optract/dist; ./nativeApp/nativeApp test`
        - then wait ~10 seconds, should see a `enter anything to stop...`, wait a few more 
          seconds to make sure nodes and ipfs are running
    - open another terminal
        - `cd ~/.config/Optract/dist; ./bin/node ./lib/console.js`
    - to stop, go back to first terminal (if use this method) and press `enter` to stop
* if update `daemon.js`, `pubSubNode.js`, or `libSampleTickets.js`, need to manually edit the `OptractDaemon.py`
    - should find simple ways to update `OptractDaemon.py`
* to develop nativeApp, there are two ways:
    1. update `package.json`, and replace `buildNativeApp` by `buildNativeAppNoArmor` and build again
        - the pyarmor-ed code are difficult to debug
    2. simply replace the `~/.config/Optract/dist/nativeApp/nativeApp` by `nativeApp.py` and
       also update the manifest file of browser extension
